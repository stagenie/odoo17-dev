<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vue formulaire vente avec bouton de remise en brouillon et bordereaux -->
    <record id="view_gecafle_vente_form_inherit_control" model="ir.ui.view">
        <field name="name">gecafle.vente.form.inherit.control</field>
        <field name="model">gecafle.vente</field>
        <field name="inherit_id" ref="adi_gecafle_ventes.view_gecafle_vente_form"/>
        <field name="arch" type="xml">
            <!-- Champs invisibles -->
            <xpath expr="//field[@name='state']" position="after">
                <field name="has_recap_lines" invisible="1"/>
                <field name="can_reset_to_draft" invisible="1"/>
                <field name="has_avoirs" invisible="1"/>
                <field name="avoir_count" invisible="1"/>
                <field name="avoir_total_amount" invisible="1"/>
                <!-- Champs pour les bordereaux -->
                <field name="vente_reception_count" invisible="1"/>
                <field name="reception_recap_count" invisible="1"/>
                <!-- Champ pour modification du prix -->
                <field name="can_edit_price" invisible="1"/>
                <field name="has_vendor_invoice_on_recap" invisible="1"/>
            </xpath>

            <!-- Alerte si facture fournisseur bloque la modification -->
            <xpath expr="//sheet" position="inside">
                <div class="alert alert-warning" role="alert"
                     invisible="not has_vendor_invoice_on_recap or state != 'valide'">
                    <strong>⚠️ Modification du prix bloquée</strong>
                    <p>Une facture fournisseur existe sur le bordereau producteur lié à cette vente.</p>
                    <p>Pour modifier le prix, vous devez d'abord supprimer la facture fournisseur et ses paiements depuis le bordereau.</p>
                </div>
            </xpath>

            <!-- Remplacer le field detail_vente_ids pour permettre la modification du prix -->
            <xpath expr="//field[@name='detail_vente_ids']" position="attributes">
                <!-- Editable si brouillon OU si can_edit_price -->
                <attribute name="readonly">state != 'brouillon' and not can_edit_price</attribute>
            </xpath>

            <!-- Rendre les champs readonly sauf prix_unitaire quand vente validée -->
            <xpath expr="//field[@name='detail_vente_ids']/tree/field[@name='reception_id']" position="attributes">
                <attribute name="readonly">parent.state != 'brouillon'</attribute>
            </xpath>

            <xpath expr="//field[@name='detail_vente_ids']/tree/field[@name='detail_reception_id']" position="attributes">
                <attribute name="readonly">parent.state != 'brouillon'</attribute>
            </xpath>

            <xpath expr="//field[@name='detail_vente_ids']/tree/field[@name='nombre_colis']" position="attributes">
                <attribute name="readonly">parent.state != 'brouillon'</attribute>
            </xpath>

            <xpath expr="//field[@name='detail_vente_ids']/tree/field[@name='poids_brut']" position="attributes">
                <attribute name="readonly">parent.state != 'brouillon'</attribute>
            </xpath>

            <!-- prix_unitaire reste éditable si can_edit_price -->
            <xpath expr="//field[@name='detail_vente_ids']/tree/field[@name='prix_unitaire']" position="attributes">
                <attribute name="readonly">parent.state != 'brouillon' and not parent.can_edit_price</attribute>
            </xpath>

            <!-- Smart buttons pour les réceptions et bordereaux -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <!-- Smart button pour les réceptions -->
                <button name="action_view_vente_receptions"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-truck"
                        invisible="vente_reception_count == 0">
                    <field name="vente_reception_count"
                           widget="statinfo"
                           string="Réceptions"/>
                </button>

                <!-- Smart button pour les bordereaux (récapitulatifs) -->
                <button name="action_view_reception_recaps"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-file-text-o"
                        invisible="reception_recap_count == 0">
                    <field name="reception_recap_count"
                           widget="statinfo"
                           string="Bordereaux"/>
                </button>
            </xpath>

            <!-- Onglet pour afficher les bordereaux des réceptions -->
            <xpath expr="//page[@name='notes']" position="after">
                <page string="Bordereaux Réceptions" name="reception_recaps"
                      invisible="reception_recap_count == 0">
                    <group>
                        <group string="Réceptions utilisées dans cette vente">
                            <field name="vente_reception_ids" nolabel="1" readonly="1">
                                <tree create="false" edit="false" delete="false">
                                    <field name="name" string="N° Réception"/>
                                    <field name="reception_date" string="Date"/>
                                    <field name="producteur_id" string="Producteur"/>
                                    <field name="state" string="État" widget="badge"
                                           decoration-info="state == 'brouillon'"
                                           decoration-success="state == 'confirmee'"
                                           decoration-danger="state == 'annulee'"/>
                                </tree>
                            </field>
                        </group>
                    </group>
                    <group>
                        <group string="Bordereaux (Récapitulatifs) associés">
                            <field name="reception_recap_ids" nolabel="1" readonly="1">
                                <tree create="false" edit="false" delete="false">
                                    <field name="name" string="N° Bordereau"/>
                                    <field name="reception_id" string="Réception"/>
                                    <field name="producteur_id" string="Producteur"/>
                                    <field name="date_creation" string="Date création"/>
                                    <field name="total_ventes" string="Total Ventes"
                                           widget="monetary"
                                           options="{'currency_field': 'currency_id'}"/>
                                    <field name="total_commission" string="Commission"
                                           widget="monetary"
                                           options="{'currency_field': 'currency_id'}"/>
                                    <field name="net_a_payer" string="Net à payer"
                                           widget="monetary"
                                           options="{'currency_field': 'currency_id'}"/>
                                    <field name="state" string="État" widget="badge"
                                           decoration-info="state == 'brouillon'"
                                           decoration-success="state == 'valide'"
                                           decoration-warning="state == 'facture'"/>
                                    <field name="payment_state" string="Paiement" widget="badge"
                                           decoration-success="payment_state == 'paid'"
                                           decoration-warning="payment_state == 'partial'"
                                           decoration-danger="payment_state == 'not_paid'"/>
                                    <field name="currency_id" invisible="1"/>
                                </tree>
                            </field>
                        </group>
                    </group>
                </page>
            </xpath>

            <!-- Bouton dans le header -->
            <xpath expr="//button[@name='action_reset_draft']" position="replace">
                <button name="action_reset_to_draft_advanced"
                        string="⚠️ Remise en Brouillon"
                        type="object"
                        class="btn-secondary"
                        icon="fa-undo"
                        invisible="not can_reset_to_draft"
                        help="Permet de remettre la vente en brouillon si aucune ligne n'est dans une récap producteur"/>
            </xpath>
        </field>
    </record>
</odoo>
