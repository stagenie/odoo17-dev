<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vue formulaire héritée de res.partner -->
    <record id="view_partner_form_gecafle_sync" model="ir.ui.view">
        <field name="name">res.partner.form.gecafle.sync</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">

            <!-- Champs invisibles -->
            <xpath expr="//field[@name='vat']" position="after">
                <field name="is_gecafle_synced" invisible="1"/>
                <field name="gecafle_client_id" invisible="1"/>
                <field name="gecafle_producteur_id" invisible="1"/>
                <field name="sync_source" invisible="1"/>
            </xpath>

            <!-- Smart buttons dans le header -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <!-- Bouton Client GECAFLE -->
                <button name="action_open_gecafle_client"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-user"
                        invisible="not gecafle_client_id"
                        groups="base.group_user">
                    <div class="o_stat_info">
                        <span class="o_stat_text">Client</span>
                        <span class="o_stat_text">GECAFLE</span>
                    </div>
                </button>

                <!-- Bouton Producteur GECAFLE -->
                <button name="action_open_gecafle_producteur"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-truck"
                        invisible="not gecafle_producteur_id"
                        groups="base.group_user">
                    <div class="o_stat_info">
                        <span class="o_stat_text">Producteur</span>
                        <span class="o_stat_text">GECAFLE</span>
                    </div>
                </button>

                <!-- Bouton Partner Ledger -->
                <button name="action_view_partner_ledger"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-book"
                        groups="account.group_account_invoice">
                    <div class="o_stat_info">
                        <span class="o_stat_text">Partner</span>
                        <span class="o_stat_text">Ledger</span>
                    </div>
                </button>
            </xpath>

            <!-- Onglet GECAFLE dans le notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="GECAFLE Sync"
                      name="gecafle_sync"
                      invisible="not is_gecafle_synced"
                      groups="base.group_user">
                    <group>
                        <group string="Liens GECAFLE">
                            <field name="gecafle_client_id"
                                   string="Client GECAFLE"
                                   readonly="1"
                                   options="{'no_create': True, 'no_open': False}"/>
                            <field name="gecafle_producteur_id"
                                   string="Producteur GECAFLE"
                                   readonly="1"
                                   options="{'no_create': True, 'no_open': False}"/>
                        </group>
                        <group string="Informations de synchronisation">
                            <field name="sync_source"
                                   string="Source de création"
                                   readonly="1"/>
                            <field name="is_gecafle_synced"
                                   string="Synchronisé avec GECAFLE"
                                   readonly="1"/>
                        </group>
                    </group>

                    <!-- Badge d'état de synchronisation -->
                    <div class="alert alert-success"
                         role="alert"
                         invisible="not is_gecafle_synced">
                        <i class="fa fa-check-circle"/> Ce contact est synchronisé avec GECAFLE
                    </div>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Vue liste héritée -->
    <record id="view_partner_tree_gecafle_sync" model="ir.ui.view">
        <field name="name">res.partner.tree.gecafle.sync</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_tree"/>
        <field name="arch" type="xml">
            <!-- Ajout d'une colonne indicateur de synchronisation -->
            <xpath expr="//field[@name='display_name']" position="after">
                <field name="is_gecafle_synced"
                       string="GECAFLE"
                       widget="boolean_toggle"
                       optional="show"
                       readonly="1"/>
            </xpath>
        </field>
    </record>

    <!-- Vue de recherche héritée - CORRIGÉE -->
    <record id="view_partner_search_gecafle_sync" model="ir.ui.view">
        <field name="name">res.partner.search.gecafle.sync</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_res_partner_filter"/>
        <field name="arch" type="xml">
            <!-- Filtre pour les contacts synchronisés après le filtre inactif -->
            <xpath expr="//filter[@name='inactive']" position="after">
                <separator/>
                <filter string="Synchronisé GECAFLE"
                        name="gecafle_synced"
                        domain="[('is_gecafle_synced', '=', True)]"/>
                <filter string="Client GECAFLE"
                        name="has_gecafle_client"
                        domain="[('gecafle_client_id', '!=', False)]"/>
                <filter string="Producteur GECAFLE"
                        name="has_gecafle_producteur"
                        domain="[('gecafle_producteur_id', '!=', False)]"/>
            </xpath>

            <!-- Groupement par source dans le groupe "Group By" existant -->
            <xpath expr="//group/filter[last()]" position="after">
                <separator/>
                <filter string="Source de création"
                        name="group_sync_source"
                        context="{'group_by': 'sync_source'}"/>
            </xpath>
        </field>
    </record>
</odoo>
