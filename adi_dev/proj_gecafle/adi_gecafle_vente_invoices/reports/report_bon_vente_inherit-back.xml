<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Héritage du template du bon de vente pour ajouter les paiements -->
    <template id="report_bon_vente_document_inherit" inherit_id="adi_gecafle_ventes.report_bon_vente_document">
        <!-- Ajouter la section paiements après les totaux -->
        <xpath expr="//div[@class='row mt-5']" position="before">
            <!-- Section Paiements (si facture existe et vente validée) -->
            <t t-if="o.invoice_id and o.state == 'valide'">
                <div class="row mt-4">
                    <div class="col-12">
                        <h5>Informations de paiement</h5>
                        <table class="table table-sm">
                            <tr>
                                <td width="60%">
                                    <strong>Montant total:</strong>
                                </td>
                                <td class="text-right">
                                    <span t-field="o.montant_total_a_payer"/>
                                </td>
                            </tr>
                            <tr t-if="o.amount_paid > 0">
                                <td>
                                    <strong>Montant payé:</strong>
                                </td>
                                <td class="text-right">
                                    <span t-field="o.amount_paid"/>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>Reste à payer:</strong>
                                </td>
                                <td class="text-right">
                                    <strong>
                                        <span t-field="o.amount_residual_signed"
                                              t-attf-class="#{o.amount_residual_signed > 0 and 'text-danger' or 'text-success'}"/>
                                    </strong>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>État du paiement:</strong>
                                </td>
                                <td class="text-right">
                                    <t t-if="o.payment_state == 'paid'">
                                        <span class="text-success fw-bold">Payé</span>
                                    </t>
                                    <t t-elif="o.payment_state == 'partial'">
                                        <span class="text-warning fw-bold">Partiellement payé</span>
                                    </t>
                                    <t t-elif="o.payment_state == 'in_payment'">
                                        <span class="text-info fw-bold">En cours de paiement</span>
                                    </t>
                                    <t t-else="">
                                        <span class="text-danger fw-bold">Non payé</span>
                                    </t>
                                </td>
                            </tr>
                        </table>

                        <!-- Détails des paiements s'il y en a -->
                        <t t-if="o.payment_ids">
                            <h6 class="mt-3">Détails des paiements:</h6>
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Référence</th>
                                        <th>Mode de paiement</th>
                                        <th class="text-right">Montant</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="o.payment_ids" t-as="payment">
                                        <td>
                                            <span t-field="payment.date" t-options='{"widget": "date"}'/>
                                        </td>
                                        <td>
                                            <span t-field="payment.name"/>
                                        </td>
                                        <td>
                                            <span t-field="payment.journal_id.name"/>
                                        </td>
                                        <td class="text-right">
                                            <span t-field="payment.amount"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </t>
                    </div>
                </div>
            </t>
        </xpath>
    </template>
</odoo>
