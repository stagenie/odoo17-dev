<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ==================== CONFIGURATION ==================== -->

    <!-- Vue Formulaire Configuration -->
    <record id="ron_production_config_view_form" model="ir.ui.view">
        <field name="name">ron.production.config.form</field>
        <field name="model">ron.production.config</field>
        <field name="arch" type="xml">
            <form string="Configuration Coût Production">
                <sheet>
                    <div class="oe_title mb-3">
                        <h1>Configuration Coût de Production</h1>
                    </div>

                    <group col="2">
                        <field name="company_id" groups="base.group_multi_company"/>
                        <field name="currency_id" invisible="1"/>
                    </group>

                    <notebook>
                        <!-- Produits Finis -->
                        <page string="Produits Finis" name="products">
                            <separator string="SOLO / CLASSICO"/>
                            <group col="2">
                                <group string="Produit SOLO">
                                    <field name="product_solo_id" placeholder="Sélectionner le produit SOLO"/>
                                    <field name="solo_weight_per_carton" string="Poids/Carton (kg)" invisible="1"/>
                                    <field name="solo_units_per_carton" string="Unités/Carton"/>
                                </group>
                                <group string="Produit CLASSICO">
                                    <field name="product_classico_id" placeholder="Sélectionner le produit CLASSICO"/>
                                    <field name="classico_weight_per_carton" string="Poids/Carton (kg)" invisible="1"/>
                                    <field name="classico_units_per_carton" string="Unités/Carton"/>
                                </group>
                            </group>
                            <group col="2">
                                <group>
                                    <field name="cost_ratio_solo_classico"/>
                                </group>
                                <group>
                                    <span class="text-muted">Formule: Coût SOLO = Ratio × Coût CLASSICO</span>
                                </group>
                            </group>

                            <separator string="Sandwich Grand Format"/>
                            <group col="2">
                                <group string="Produit Sandwich GF">
                                    <field name="product_sandwich_id" placeholder="Sélectionner le produit Sandwich"/>
                                    <field name="sandwich_weight_per_carton" string="Poids/Carton (kg)" invisible="1"/>
                                    <field name="sandwich_units_per_carton" string="Unités/Carton"/>
                                </group>
                                <group>
                                    <span class="text-muted mt-4">Le Sandwich GF est produit séparément (calcul direct sans ratio).</span>
                                </group>
                            </group>
                        </page>

                        <!-- Dépôts et Emplacements -->
                        <page string="Dépôts" name="warehouses">
                            <group col="2">
                                <group string="Dépôts de Stockage">
                                    <field name="warehouse_mp_id" string="Dépôt Matière Première (DMP)"/>
                                    <field name="warehouse_production_id" string="Dépôt Production (DPR)"/>
                                    <field name="warehouse_pf_id" string="Dépôt Produits Finis (DPF)"/>
                                </group>
                                <group string="Emplacement">
                                    <field name="location_production_id"/>
                                </group>
                            </group>
                            <div class="alert alert-info mt-3" role="alert">
                                <strong>Architecture des Dépôts:</strong><br/>
                                - <b>DMP:</b> Dépôt Matière Première (achats avec méthode AVCO)<br/>
                                - <b>DPR:</b> Dépôt Production (simulation via BL vers contact Consommation)<br/>
                                - <b>DPF:</b> Dépôt Produits Finis (réception via achat depuis fournisseur Production)
                            </div>
                        </page>

                        <!-- Partenaires -->
                        <page string="Partenaires" name="partners">
                            <group col="2">
                                <group string="Partenaires Fictifs">
                                    <field name="partner_consumption_id" string="Contact Consommation"/>
                                    <field name="partner_production_id" string="Fournisseur Production"/>
                                </group>
                                <group/>
                            </group>
                            <div class="alert alert-warning mt-3" role="alert">
                                <strong>Partenaires Fictifs:</strong><br/>
                                - <b>Contact Consommation:</b> Pour les BL de déstockage des matières premières<br/>
                                - <b>Fournisseur Production:</b> Pour les achats de produits finis (entrée en stock avec coût calculé)
                            </div>
                        </page>

                        <!-- Paramètres -->
                        <page string="Paramètres" name="settings">
                            <group col="2">
                                <group string="Création Automatique">
                                    <field name="auto_create_delivery" widget="boolean_toggle"/>
                                    <field name="auto_create_purchase" widget="boolean_toggle"/>
                                </group>
                                <group string="Produit Pâte Récupérable">
                                    <field name="product_paste_id"/>
                                </group>
                            </group>

                            <separator string="Validation Automatique des Opérations"/>
                            <group col="2">
                                <group>
                                    <field name="auto_validate_operations" widget="boolean_toggle"/>
                                    <field name="auto_create_supplier_invoice" widget="boolean_toggle"
                                           invisible="not auto_validate_operations"/>
                                </group>
                                <group/>
                            </group>
                            <div class="alert alert-warning mt-2" role="alert"
                                 invisible="not auto_validate_operations">
                                <strong>Attention:</strong> Si activé, lors de la validation:<br/>
                                - Le BL de consommation sera validé (sortie de stock)<br/>
                                - Les achats seront confirmés et réceptionnés<br/>
                                - Les factures fournisseur seront créées (si coché)
                            </div>

                            <separator string="Calcul des Coûts Emballage"/>
                            <group col="2">
                                <group>
                                    <field name="separate_packaging_costs" widget="boolean_toggle"/>
                                </group>
                                <group/>
                            </group>
                            <div class="alert alert-info mt-2" role="alert"
                                 invisible="separate_packaging_costs">
                                <strong>Mode Standard:</strong> Tous les coûts d'emballage sont répartis avec le ratio SOLO/CLASSICO.<br/>
                                <em>Formule: Coût SOLO = Ratio × Coût CLASSICO</em>
                            </div>
                            <div class="alert alert-warning mt-2" role="alert"
                                 invisible="not separate_packaging_costs">
                                <strong>Mode Séparation des Emballages:</strong><br/>
                                - <b>Commun:</b> Réparti avec le ratio SOLO/CLASSICO (comme les matières premières)<br/>
                                - <b>SOLO:</b> Affecté directement au coût SOLO (divisé par nombre de cartons SOLO)<br/>
                                - <b>CLASSICO:</b> Affecté directement au coût CLASSICO (divisé par nombre de cartons CLASSICO)<br/><br/>
                                <em>Exemple: 100 cartons SOLO + 1000 DA emballage SOLO = 10 DA/carton supplémentaire pour SOLO uniquement</em>
                            </div>

                            <separator string="Informations"/>
                            <div class="alert alert-info" role="alert">
                                <strong>Produit Pâte:</strong> Ce produit sera utilisé pour créer l'achat de pâte récupérable (stock AVCO).<br/><br/>
                                <strong>Produits Rebuts:</strong> Les rebuts récupérables sont configurés directement sur la fiche produit.
                                Allez dans <b>Inventaire &gt; Produits</b> et cochez <b>"Est un Rebut Récupérable"</b> pour les produits vendables issus de la production.<br/><br/>
                                <strong>Contrôle Stock:</strong> La validation vérifie automatiquement que le stock est disponible pour toutes les matières premières.
                            </div>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Action Configuration -->
    <record id="ron_production_config_action" model="ir.actions.act_window">
        <field name="name">Configuration Coût Production</field>
        <field name="res_model">ron.production.config</field>
        <field name="view_mode">form</field>
        <field name="target">current</field>
        <field name="context">{'form_view_initial_mode': 'edit'}</field>
    </record>

    <!-- Action pour ouvrir la config (méthode) -->
    <record id="ron_production_config_action_open" model="ir.actions.server">
        <field name="name">Ouvrir Configuration</field>
        <field name="model_id" ref="model_ron_production_config"/>
        <field name="state">code</field>
        <field name="code">
action = model.get_config().action_open_config()
        </field>
    </record>

</odoo>
