<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Action Rapport -->
    <record id="action_report_daily_production" model="ir.actions.report">
        <field name="name">Fiche Production Journalière</field>
        <field name="model">ron.daily.production</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">adi_simple_production_cost.report_daily_production_document</field>
        <field name="report_file">adi_simple_production_cost.report_daily_production_document</field>
        <field name="print_report_name">'Production_%s' % object.name</field>
        <field name="binding_model_id" ref="model_ron_daily_production"/>
        <field name="binding_type">report</field>
    </record>

    <!-- Template Rapport -->
    <template id="report_daily_production_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="web.external_layout">
                    <div class="page">
                        <!-- En-tête -->
                        <div class="row">
                            <div class="col-12 text-center">
                                <h2>Fiche de Production Journalière</h2>
                                <h4><t t-esc="doc.name"/></h4>
                            </div>
                        </div>

                        <!-- Informations générales -->
                        <div class="row mt-4">
                            <div class="col-4">
                                <strong>Date de Production:</strong>
                                <span t-field="doc.production_date"/>
                            </div>
                            <div class="col-4 text-center">
                                <strong>Type:</strong>
                                <t t-if="doc.production_type == 'solo_classico'">
                                    <span class="badge bg-primary">SOLO / CLASSICO</span>
                                </t>
                                <t t-else="">
                                    <span class="badge bg-success">Sandwich Grand Format</span>
                                </t>
                            </div>
                            <div class="col-4 text-end">
                                <strong>État:</strong>
                                <span t-field="doc.state"/>
                            </div>
                        </div>

                        <!-- Section Consommations -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="bg-primary text-white p-2">Consommations du Jour</h5>
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Produit</th>
                                            <th class="text-end">Quantité</th>
                                            <th class="text-end">Poids/Unité</th>
                                            <th class="text-end">Poids Total (kg)</th>
                                            <th class="text-end">Coût Unitaire</th>
                                            <th class="text-end">Coût Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="doc.consumption_line_ids" t-as="line">
                                            <tr>
                                                <td><t t-esc="line.product_id.name"/></td>
                                                <td class="text-end"><t t-esc="line.quantity"/> <t t-esc="line.product_uom_id.name"/></td>
                                                <td class="text-end"><t t-esc="'%.2f' % line.weight_per_unit"/> kg</td>
                                                <td class="text-end"><t t-esc="'%.2f' % line.weight_kg"/> kg</td>
                                                <td class="text-end"><t t-esc="'%.2f' % line.unit_cost"/> <t t-esc="doc.currency_id.symbol"/></td>
                                                <td class="text-end"><t t-esc="'%.2f' % line.total_cost"/> <t t-esc="doc.currency_id.symbol"/></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                    <tfoot class="table-secondary">
                                        <tr>
                                            <td colspan="3"><strong>TOTAUX</strong></td>
                                            <td class="text-end"><strong><t t-esc="'%.2f' % doc.total_consumption_weight"/> kg</strong></td>
                                            <td></td>
                                            <td class="text-end"><strong><t t-esc="'%.2f' % doc.total_consumption_cost"/> <t t-esc="doc.currency_id.symbol"/></strong></td>
                                        </tr>
                                        <tr>
                                            <td colspan="5"><strong>Coût par Kg</strong></td>
                                            <td class="text-end"><strong><t t-esc="'%.2f' % doc.cost_per_kg"/> <t t-esc="doc.currency_id.symbol"/>/kg</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- Section Rebuts et Pâte Récupérables -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="bg-warning text-dark p-2">Rebuts et Pâte Récupérables</h5>
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Type</th>
                                            <th>Produit</th>
                                            <th class="text-end">Poids (kg)</th>
                                            <th class="text-end">Coût/Kg</th>
                                            <th class="text-end">Coût Total</th>
                                            <th>Raison</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="doc.scrap_line_ids" t-as="scrap">
                                            <tr>
                                                <td><t t-esc="scrap.type_display"/></td>
                                                <td><t t-esc="scrap.product_id.name or '-'"/></td>
                                                <td class="text-end"><t t-esc="'%.2f' % scrap.weight_kg"/> kg</td>
                                                <td class="text-end"><t t-esc="'%.2f' % scrap.cost_per_kg"/> <t t-esc="doc.currency_id.symbol"/></td>
                                                <td class="text-end"><t t-esc="'%.2f' % scrap.total_cost"/> <t t-esc="doc.currency_id.symbol"/></td>
                                                <td><t t-esc="scrap.reason or ''"/></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                    <tfoot class="table-secondary">
                                        <tr>
                                            <td colspan="2"><strong>Rebuts Récupérables</strong></td>
                                            <td class="text-end"><strong><t t-esc="'%.2f' % doc.scrap_recoverable_weight"/> kg</strong></td>
                                            <td></td>
                                            <td class="text-end"><strong><t t-esc="'%.2f' % doc.scrap_recoverable_cost"/> <t t-esc="doc.currency_id.symbol"/></strong></td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"><strong>Pâte Récupérable (Stock AVCO)</strong></td>
                                            <td class="text-end"><strong><t t-esc="'%.2f' % doc.paste_recoverable_weight"/> kg</strong></td>
                                            <td></td>
                                            <td class="text-end"><strong><t t-esc="'%.2f' % doc.paste_recoverable_cost"/> <t t-esc="doc.currency_id.symbol"/></strong></td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- Section Emballage - SOLO/CLASSICO -->
                        <t t-if="doc.production_type == 'solo_classico' and doc.total_packaging_cost > 0">
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h5 class="bg-secondary text-white p-2">Coûts Emballage</h5>
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Type</th>
                                                <th class="text-end">SOLO</th>
                                                <th class="text-end">CLASSICO</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Emballage (cartons)</td>
                                                <td class="text-end"><t t-esc="'%.2f' % doc.emballage_solo_cost"/> <t t-esc="doc.currency_id.symbol"/></td>
                                                <td class="text-end"><t t-esc="'%.2f' % doc.emballage_classico_cost"/> <t t-esc="doc.currency_id.symbol"/></td>
                                            </tr>
                                            <tr>
                                                <td>Film</td>
                                                <td class="text-end"><t t-esc="'%.2f' % doc.film_solo_cost"/> <t t-esc="doc.currency_id.symbol"/></td>
                                                <td class="text-end"><t t-esc="'%.2f' % doc.film_classico_cost"/> <t t-esc="doc.currency_id.symbol"/></td>
                                            </tr>
                                        </tbody>
                                        <tfoot class="table-info">
                                            <tr>
                                                <td><strong>Total</strong></td>
                                                <td class="text-end"><strong><t t-esc="'%.2f' % (doc.emballage_solo_cost + doc.film_solo_cost)"/> <t t-esc="doc.currency_id.symbol"/></strong></td>
                                                <td class="text-end"><strong><t t-esc="'%.2f' % (doc.emballage_classico_cost + doc.film_classico_cost)"/> <t t-esc="doc.currency_id.symbol"/></strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </t>

                        <!-- Section Emballage - SANDWICH GF -->
                        <t t-if="doc.production_type == 'sandwich_gf' and doc.total_packaging_cost > 0">
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h5 class="bg-secondary text-white p-2">Coûts Emballage</h5>
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Type</th>
                                                <th class="text-end">Sandwich GF</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Emballage (cartons)</td>
                                                <td class="text-end"><t t-esc="'%.2f' % doc.emballage_sandwich_cost"/> <t t-esc="doc.currency_id.symbol"/></td>
                                            </tr>
                                            <tr>
                                                <td>Film</td>
                                                <td class="text-end"><t t-esc="'%.2f' % doc.film_sandwich_cost"/> <t t-esc="doc.currency_id.symbol"/></td>
                                            </tr>
                                        </tbody>
                                        <tfoot class="table-info">
                                            <tr>
                                                <td><strong>Total</strong></td>
                                                <td class="text-end"><strong><t t-esc="'%.2f' % doc.total_packaging_cost"/> <t t-esc="doc.currency_id.symbol"/></strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </t>

                        <!-- Section Produits Finis -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="bg-success text-white p-2">Produits Finis</h5>
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Produit</th>
                                            <th class="text-end">Quantité (Cartons)</th>
                                            <th class="text-end">Unités/Carton</th>
                                            <th class="text-end">Total Unités</th>
                                            <th class="text-end">Coût/Carton</th>
                                            <th class="text-end">Coût Total</th>
                                            <th class="text-end">Prix Vente</th>
                                            <th class="text-end">Marge</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="doc.finished_product_ids" t-as="fp">
                                            <tr>
                                                <td>
                                                    <t t-if="fp.product_type == 'solo'">SOLO</t>
                                                    <t t-elif="fp.product_type == 'classico'">CLASSICO</t>
                                                    <t t-else="">Sandwich GF</t>
                                                </td>
                                                <td class="text-end"><t t-esc="'%.0f' % fp.quantity"/></td>
                                                <td class="text-end"><t t-esc="fp.units_per_carton"/></td>
                                                <td class="text-end"><t t-esc="'%.0f' % fp.total_units"/></td>
                                                <td class="text-end"><t t-esc="'%.2f' % fp.unit_cost"/> <t t-esc="doc.currency_id.symbol"/></td>
                                                <td class="text-end"><t t-esc="'%.2f' % fp.total_cost"/> <t t-esc="doc.currency_id.symbol"/></td>
                                                <td class="text-end"><t t-esc="'%.2f' % fp.sale_price"/> <t t-esc="doc.currency_id.symbol"/></td>
                                                <td class="text-end">
                                                    <t t-esc="'%.2f' % fp.margin"/> <t t-esc="doc.currency_id.symbol"/>
                                                    (<t t-esc="'%.1f' % fp.margin_percent"/>%)
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                    <tfoot class="table-secondary">
                                        <tr>
                                            <td><strong>Total</strong></td>
                                            <td class="text-end"><strong><t t-esc="'%.0f' % doc.total_cartons_produced"/> cartons</strong></td>
                                            <td colspan="6"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- Résumé Final -->
                        <div class="row mt-4">
                            <div class="col-6">
                                <h5 class="bg-info text-white p-2">Résumé Production</h5>
                                <table class="table table-sm">
                                    <tr>
                                        <td>Poids Total Consommé</td>
                                        <td class="text-end"><strong><t t-esc="'%.2f' % doc.total_consumption_weight"/> kg</strong></td>
                                    </tr>
                                    <tr>
                                        <td>Rebuts Récupérables</td>
                                        <td class="text-end text-danger"><strong>- <t t-esc="'%.2f' % doc.scrap_recoverable_weight"/> kg</strong></td>
                                    </tr>
                                    <tr>
                                        <td>Pâte Récupérable</td>
                                        <td class="text-end text-warning"><strong>- <t t-esc="'%.2f' % doc.paste_recoverable_weight"/> kg</strong></td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>Poids Bon</strong></td>
                                        <td class="text-end"><strong><t t-esc="'%.2f' % doc.good_weight"/> kg</strong></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-6">
                                <h5 class="bg-info text-white p-2">Résumé Coûts</h5>
                                <table class="table table-sm">
                                    <tr>
                                        <td>Coût Matières Premières</td>
                                        <td class="text-end"><strong><t t-esc="'%.2f' % doc.total_consumption_cost"/> <t t-esc="doc.currency_id.symbol"/></strong></td>
                                    </tr>
                                    <tr>
                                        <td>Coût Emballage</td>
                                        <td class="text-end"><strong><t t-esc="'%.2f' % doc.total_packaging_cost"/> <t t-esc="doc.currency_id.symbol"/></strong></td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>Coût Total Production</strong></td>
                                        <td class="text-end"><strong><t t-esc="'%.2f' % doc.total_good_cost"/> <t t-esc="doc.currency_id.symbol"/></strong></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Coût/Kg Bon</strong></td>
                                        <td class="text-end"><strong><t t-esc="'%.2f' % doc.cost_per_kg_good"/> <t t-esc="doc.currency_id.symbol"/>/kg</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Tableau des Coûts par Produit - SOLO/CLASSICO -->
                        <t t-if="doc.production_type == 'solo_classico'">
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h5 class="bg-dark text-white p-2">Coûts de Revient - SOLO / CLASSICO</h5>
                                    <table class="table table-bordered">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Produit</th>
                                                <th class="text-end">Quantité</th>
                                                <th class="text-end">Coût/Carton</th>
                                                <th class="text-end">Coût Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>SOLO</strong></td>
                                                <td class="text-end"><t t-esc="'%.0f' % doc.qty_solo_cartons"/> cartons</td>
                                                <td class="text-end"><t t-esc="'%.2f' % doc.cost_solo_per_carton"/> <t t-esc="doc.currency_id.symbol"/></td>
                                                <td class="text-end"><t t-esc="'%.2f' % doc.total_solo_cost"/> <t t-esc="doc.currency_id.symbol"/></td>
                                            </tr>
                                            <tr>
                                                <td><strong>CLASSICO</strong></td>
                                                <td class="text-end"><t t-esc="'%.0f' % doc.qty_classico_cartons"/> cartons</td>
                                                <td class="text-end"><t t-esc="'%.2f' % doc.cost_classico_per_carton"/> <t t-esc="doc.currency_id.symbol"/></td>
                                                <td class="text-end"><t t-esc="'%.2f' % doc.total_classico_cost"/> <t t-esc="doc.currency_id.symbol"/></td>
                                            </tr>
                                        </tbody>
                                        <tfoot class="table-secondary">
                                            <tr>
                                                <td colspan="3"><strong>TOTAL</strong></td>
                                                <td class="text-end"><strong><t t-esc="'%.2f' % (doc.total_solo_cost + doc.total_classico_cost)"/> <t t-esc="doc.currency_id.symbol"/></strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </t>

                        <!-- Tableau des Coûts par Produit - Sandwich GF -->
                        <t t-if="doc.production_type == 'sandwich_gf'">
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h5 class="bg-dark text-white p-2">Coûts de Revient - Sandwich Grand Format</h5>
                                    <table class="table table-bordered">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Produit</th>
                                                <th class="text-end">Quantité</th>
                                                <th class="text-end">Coût/Carton</th>
                                                <th class="text-end">Coût Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>Sandwich Grand Format</strong></td>
                                                <td class="text-end"><t t-esc="'%.0f' % doc.qty_sandwich_cartons"/> cartons</td>
                                                <td class="text-end"><t t-esc="'%.2f' % doc.cost_sandwich_per_carton"/> <t t-esc="doc.currency_id.symbol"/></td>
                                                <td class="text-end"><t t-esc="'%.2f' % doc.total_sandwich_cost"/> <t t-esc="doc.currency_id.symbol"/></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </t>

                        <!-- Notes -->
                        <t t-if="doc.notes">
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h5>Notes</h5>
                                    <p t-field="doc.notes"/>
                                </div>
                            </div>
                        </t>

                        <!-- Pied de page -->
                        <div class="row mt-5">
                            <div class="col-12 text-center">
                                <small class="text-muted">
                                    Document généré le <t t-esc="context_timestamp(datetime.datetime.now()).strftime('%d/%m/%Y %H:%M')"/>
                                </small>
                            </div>
                        </div>

                    </div>
                </t>
            </t>
        </t>
    </template>

</odoo>
